<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>SynchroBots 통합 관제 대시보드</title>

  <!-- Flask로 쓸 때 -->
  <link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard.css') }}">

  <!-- 단독 HTML로 테스트할 때는 아래처럼 상대경로도 가능
  <link rel="stylesheet" href="dashboard.css">
  -->

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <div class="page">
    <!-- 상단 헤더 -->
    <header class="header">
      <div>
        <div class="header-title">SynchroBots 통합 관제 대시보드</div>
        <div class="header-sub">AGV · RobotArm · PLC · 이벤트 · 제어 로그</div>
      </div>
      <span class="badge">DEMO · MOCK DATA</span>
    </header>

    <!-- 메인 레이아웃 -->
    <main class="content">
      <!-- 좌측 컬럼: 맵 + 미션 -->
      <section class="left-column">
        <!-- AGV 맵 카드 -->
        <section class="card card-map">
          <div class="card-header">
            <div>
              <div class="card-title">AGV 네비게이션 맵</div>
              <div class="card-sub">경로 · 체크포인트 · 현재 위치 · 이탈 지점</div>
            </div>
            <span class="pill">Layer: map / path / robot</span>
          </div>

          <div class="agv-map">
            <div class="map-grid"></div>
            <div class="agv-path">
              <!-- 체크포인트 예시 -->
              <div class="agv-node checkpoint" style="left: 14%; top: 16%;"></div>
              <div class="agv-node checkpoint" style="left: 36%; top: 44%;"></div>
              <div class="agv-node checkpoint" style="left: 64%; top: 28%;"></div>

              <!-- 현재 AGV 위치 -->
              <div class="agv-node" style="left: 52%; top: 62%;">
                <div class="agv-label">AGV #01</div>
              </div>

              <!-- 네비 이탈 지점 예시 -->
              <div class="agv-node error" style="left: 78%; top: 76%;">
                <div class="agv-label">Out of Route</div>
              </div>
            </div>
          </div>

          <div class="chip-row">
            <span class="chip">AGV #01 · RUNNING</span>
            <span class="chip">목적지: ST-03</span>
            <span class="chip">예상 도착: 02:13</span>
          </div>

          <div class="status-list">
            <div class="status-item">
              <div class="status-label">
                <span class="dot green"></span>
                <span>AGV #01 상태</span>
              </div>
              <div class="status-value">정상 주행</div>
            </div>
            <div class="status-item">
              <div class="status-label">
                <span class="dot yellow"></span>
                <span>AGV #02 상태</span>
              </div>
              <div class="status-value">대기 · ZONE-B</div>
            </div>
            <div class="status-item">
              <div class="status-label">
                <span class="dot red"></span>
                <span>AGV #03 상태</span>
              </div>
              <div class="status-value">경로 이탈 감지</div>
            </div>
          </div>
        </section>

        <!-- 미션 / 작업 로그 카드 -->
        <section class="card card-mission">
          <div class="card-header">
            <div>
              <div class="card-title">미션 · 작업 로그 (mission_logs)</div>
              <div class="card-sub">진행 중 / 최근 완료된 미션 현황</div>
            </div>
            <span class="pill">최근 5건</span>
          </div>

          <div class="mission-list" id="mission-list"></div>
        </section>
      </section>

      <!-- 우측 컬럼: 차트 + 이벤트 로그 + 제어 로그 -->
      <section class="right-column">
        <!-- 요약 차트 -->
        <section class="card card-summary">
          <div class="card-header">
            <div>
              <div class="card-title">물류 분류 · 적재 성능 요약</div>
              <div class="card-sub">분류 수량(막대) · 적재 성공률(선)</div>
            </div>
            <span class="pill">최근 1시간 · Mock</span>
          </div>

          <div class="chart-col">
            <div class="chart-box">
              <div class="card-sub chart-caption">카테고리별 분류 수량</div>
              <canvas id="classifyChart" height="100"></canvas>
            </div>
            <div class="chart-box">
              <div class="card-sub chart-caption">적재 성공률 추이</div>
              <canvas id="successChart" height="100"></canvas>
            </div>
          </div>
        </section>

        <!-- 이벤트 로그 -->
        <section class="card card-events">
          <div class="card-header">
            <div>
              <div class="card-title">이벤트 로그 (events_log)</div>
              <div class="card-sub">AGV · Robot · PLC 주요 이벤트</div>
            </div>
            <span class="pill">최근 10건</span>
          </div>

          <div class="log-table" id="events-table">
            <div class="log-header">
              <span>시간</span>
              <span>장비</span>
              <span>내용</span>
            </div>
          </div>
        </section>

        <!-- 제어 명령 로그 -->
        <section class="card card-control">
          <div class="card-header">
            <div>
              <div class="card-title">제어 명령 로그 (control_logs)</div>
              <div class="card-sub">Web → API → 장비로 전송된 명령 이력</div>
            </div>
            <span class="pill">최근 10건</span>
          </div>

          <div class="log-table" id="control-table">
            <div class="log-header">
              <span>시간</span>
              <span>대상</span>
              <span>명령 / 결과</span>
            </div>
          </div>
        </section>
      </section>
    </main>
  </div>

  <!-- JS: Mock 데이터 + 렌더링 -->
  <script>
    // ==============================
    // 1. Mock 데이터 (나중에 Flask에서 DB 연동 시 교체)
    // ==============================
    const eventLogs = [
      { time: "10:21:03", device_id: "AGV03", device_type: "AGV", level: "ERR",  message: "경로 이탈 감지 · 속도 자동 감속" },
      { time: "10:20:11", device_id: "ARM01", device_type: "ARM", level: "INFO", message: "픽업 완료 · 다음 공정으로 이송" },
      { time: "10:19:44", device_id: "PLC01", device_type: "PLC", level: "INFO", message: "센서 IN_07 ON (팔레트 감지)" },
      { time: "10:18:22", device_id: "AGV01", device_type: "AGV", level: "WARN", message: "충돌 가능 구역 진입 · 감속" },
      { time: "10:17:01", device_id: "ARM02", device_type: "ARM", level: "ERR",  message: "그리퍼 미채결 · 재시도 필요" },
      { time: "10:16:33", device_id: "PLC01", device_type: "PLC", level: "WARN", message: "비상 스위치 ON 입력 감지" },
      { time: "10:15:25", device_id: "AGV02", device_type: "AGV", level: "INFO", message: "미션 #12 완료 · ST-03 도착" },
      { time: "10:14:10", device_id: "ARM01", device_type: "ARM", level: "INFO", message: "홈 포지션 복귀 완료" },
      { time: "10:13:52", device_id: "HMI01", device_type: "HMI", level: "INFO", message: "오퍼레이터 로그인(김**)" },
      { time: "10:12:18", device_id: "PLC01", device_type: "PLC", level: "INFO", message: "라인 기동 시퀀스 시작" }
    ];

    const controlLogs = [
      { time: "10:21:05", device_id: "AGV03", device_type: "AGV", command: "AGV_ESTOP",       result: "SUCCESS" },
      { time: "10:20:58", device_id: "AGV03", device_type: "AGV", command: "AGV_RESUME",      result: "SUCCESS" },
      { time: "10:19:50", device_id: "ARM02", device_type: "ARM", command: "ROBOT_HOME",      result: "SUCCESS" },
      { time: "10:19:47", device_id: "ARM02", device_type: "ARM", command: "ROBOT_PAUSE",     result: "SUCCESS" },
      { time: "10:18:30", device_id: "PLC01", device_type: "PLC", command: "PLC_Y002_ON",     result: "SUCCESS" },
      { time: "10:18:10", device_id: "PLC01", device_type: "PLC", command: "PLC_Y002_OFF",    result: "SUCCESS" },
      { time: "10:17:40", device_id: "AGV01", device_type: "AGV", command: "AGV_RESUME",      result: "SUCCESS" },
      { time: "10:16:05", device_id: "AGV01", device_type: "AGV", command: "AGV_ESTOP",       result: "SUCCESS" },
      { time: "10:15:11", device_id: "ARM01", device_type: "ARM", command: "ROBOT_HOME",      result: "SUCCESS" },
      { time: "10:14:00", device_id: "PLC01", device_type: "PLC", command: "PLC_LINE_START",  result: "SUCCESS" }
    ];

    const missionLogs = [
      { mission_id: "AGV-12", device_id: "AGV01", status: "RUNNING", step: "MOVE_TO_ST-03",  created_at: "10:20:30" },
      { mission_id: "AGV-11", device_id: "AGV02", status: "DONE",    step: "COMPLETED",      created_at: "10:18:05" },
      { mission_id: "ARM-05", device_id: "ARM01", status: "DONE",    step: "PLACE_DONE",     created_at: "10:19:10" },
      { mission_id: "ARM-06", device_id: "ARM02", status: "ERROR",   step: "PICK_RETRY",     created_at: "10:17:02" },
      { mission_id: "SYS-BOOT", device_id: "PLC01", status: "DONE",  step: "SEQUENCE_OK",    created_at: "10:12:00" }
    ];

    // 물류 분류 / 적재 관련 Mock 데이터 (나중에 DB 값으로 교체)
    const classifyStats = [
      { category: "Zone A", count: 24 },
      { category: "Zone B", count: 18 },
      { category: "Zone C", count: 12 },
      { category: "Reject", count: 3 },
    ];

    const successRateLogs = [
      { label: "10:00", rate: 82 },
      { label: "10:10", rate: 85 },
      { label: "10:20", rate: 80 },
      { label: "10:30", rate: 88 },
      { label: "10:40", rate: 90 },
      { label: "10:50", rate: 92 },
    ];

    // ==============================
    // 2. Chart.js 차트 렌더링 (분류 막대 + 성공률 선)
    // ==============================
    const classifyCtx = document
      .getElementById("classifyChart")
      .getContext("2d");

    new Chart(classifyCtx, {
      type: "bar",
      data: {
        labels: classifyStats.map((c) => c.category),
        datasets: [
          {
            data: classifyStats.map((c) => c.count),
            borderWidth: 1,
          },
        ],
      },
      options: {
        plugins: { legend: { display: false } },
        responsive: false,
        maintainAspectRatio: false,
        scales: {
          y: {
            beginAtZero: true,
            ticks: { color: "#9ca3af", font: { size: 10 } },
            grid: { color: "rgba(148,163,184,0.25)" },
          },
          x: {
            ticks: { color: "#9ca3af", font: { size: 10 } },
            grid: { display: false },
          },
        },
      },
    });

    const successCtx = document
      .getElementById("successChart")
      .getContext("2d");

    new Chart(successCtx, {
      type: "line",
      data: {
        labels: successRateLogs.map((s) => s.label),
        datasets: [
          {
            data: successRateLogs.map((s) => s.rate),
            borderWidth: 1,
            tension: 0.3,
            fill: false,
          },
        ],
      },
      options: {
        responsive: false,
        maintainAspectRatio: false,
        plugins: {
          legend: { display: false },
          tooltip: {
            callbacks: {
              label: (ctx) => `성공률: ${ctx.parsed.y}%`,
            },
          },
        },
        scales: {
          y: {
            beginAtZero: true,
            max: 100,
            ticks: { color: "#9ca3af", font: { size: 10 } },
            grid: { color: "rgba(148,163,184,0.25)" },
          },
          x: {
            ticks: { color: "#9ca3af", font: { size: 10 } },
            grid: { display: false },
          },
        },
      },
    });

    // ==============================
    // 4. 미션 리스트 렌더링
    // ==============================
    const missionList = document.getElementById("mission-list");
    missionLogs.forEach(m => {
      const item = document.createElement("div");
      item.className = "mission-item";

      const main = document.createElement("div");
      main.className = "mission-main";

      const id = document.createElement("div");
      id.className = "mission-id";
      id.textContent = `${m.device_id} · ${m.mission_id}`;

      const meta = document.createElement("div");
      meta.className = "mission-meta";
      meta.textContent = `단계: ${m.step} / 시작: ${m.created_at}`;

      main.appendChild(id);
      main.appendChild(meta);

      const st = document.createElement("div");
      st.className =
        "status-pill " +
        (m.status === "RUNNING"
          ? "status-running"
          : m.status === "DONE"
          ? "status-done"
          : "status-error");
      st.textContent = m.status;

      item.appendChild(main);
      item.appendChild(st);
      missionList.appendChild(item);
    });

    // ==============================
    // 5. 이벤트 로그 렌더링
    // ==============================
    function createEventRow(e) {
      const row = document.createElement("div");
      row.className = "log-row";

      const colTime = document.createElement("span");
      colTime.textContent = e.time;

      const colDevice = document.createElement("span");
      colDevice.textContent = e.device_id;

      const colMsg = document.createElement("span");

      const tag = document.createElement("span");
      tag.className = "log-tag";
      tag.textContent = e.device_type;

      const level = document.createElement("span");
      level.className =
        "log-level " +
        (e.level === "ERR"
          ? "lvl-err"
          : e.level === "WARN"
          ? "lvl-warn"
          : "lvl-info");
      level.textContent = e.level;

      const text = document.createElement("span");
      text.textContent = "  " + e.message;

      colMsg.appendChild(tag);
      colMsg.appendChild(level);
      colMsg.appendChild(text);

      row.appendChild(colTime);
      row.appendChild(colDevice);
      row.appendChild(colMsg);
      return row;
    }

    const eventsTable = document.getElementById("events-table");
    eventLogs.forEach(e => {
      eventsTable.appendChild(createEventRow(e));
    });

    // ==============================
    // 6. 제어 로그 렌더링
    // ==============================
    function createControlRow(c) {
      const row = document.createElement("div");
      row.className = "log-row";

      const colTime = document.createElement("span");
      colTime.textContent = c.time;

      const colDevice = document.createElement("span");
      colDevice.textContent = c.device_id;

      const colMsg = document.createElement("span");

      const tag = document.createElement("span");
      tag.className = "log-tag";
      tag.textContent = c.device_type;

      const result = document.createElement("span");
      result.className =
        "log-level " + (c.result === "SUCCESS" ? "lvl-info" : "lvl-err");
      result.textContent = c.result;

      const text = document.createElement("span");
      text.textContent = "  " + c.command;

      colMsg.appendChild(tag);
      colMsg.appendChild(result);
      colMsg.appendChild(text);

      row.appendChild(colTime);
      row.appendChild(colDevice);
      row.appendChild(colMsg);
      return row;
    }

    const controlTable = document.getElementById("control-table");
    controlLogs.forEach(c => {
      controlTable.appendChild(createControlRow(c));
    });

    // ==============================
    // (참고) 나중에 실제 AGV 위치를 WebSocket/REST로 받으면
    // 여기서 agv-node 의 style.left/top 을 동적으로 바꿔주면 됨
    // ==============================
  </script>
</body>
</html>
